library(ggplot2)
library(dplyr)
library(MOFA2)

setwd("C:/Users/49152/Downloads/Multi-omics/SCOT_plus/MOFA_output/")
model <- load_model("SCOTplus_trained_model.hdf5")

plot_data_overview(model)
model@samples_metadata
model@samples_metadata <- model@samples_metadata %>%
  mutate(cell_line = sub("^[^_]+_([^_]+).*", "\\1", sample))
model@samples_metadata

# Total variance explained per view and group
model@cache$variance_explained$r2_total
model@cache$variance_explained$r2_per_factor
plot_variance_explained(model, x="view", y="factor", plot_total = FALSE)
plot_variance_explained(model, x="view", y="factor", plot_total = TRUE)

plot_factor(model, factor = 1:6, color_by = "cell_line")

p <- plot_factor(model, 
                 factors = c(1,2,3,4,5,6),
                 color_by = "cell_line",
                 dot_size = 3,        # change dot size
                 dodge = T,           # dodge points with different colors
                 legend = F,          # remove legend
                 add_violin = T,      # add violin plots,
                 violin_alpha = 0.25  # transparency of violin plots
)

# The output of plot_factor is a ggplot2 object that we can edit
p <- p + 
  scale_color_manual(values=c("C10"="black", "SVEC"="red")) +
  scale_fill_manual(values=c("C10"="black", "SVEC"="red"))

print(p)

plot_factors(model, 
             factors = 1:6,
             color_by = "cell_line"
)


views <- c("Transcriptomics", "Proteomics")
K <- get_dimensions(model)$K
factors <- seq_len(K)

outdir <- "C:/Users/49152/Downloads/Multi-omics/SCOT_plus/MOFA_output/graphs/Downstream_general/"

for (v in views) {
  for (f in factors) {
    
    message("Processing: ", v, " | Factor ", f)
    
    # =====================================================
    # 1. Weights (ggplot)
    # =====================================================
    p_weights <- plot_weights(
      model,
      view = v,
      factor = f,
      nfeatures = 10,
      scale = TRUE,
      abs = FALSE,
      text_size = 2
    )
    
    ggsave(
      file.path(outdir, paste0(v, "_F", f, "_weights.png")),
      p_weights, width = 6, height = 4, dpi = 300
    )
    
    
    # =====================================================
    # 2. Top weights (ggplot)
    # =====================================================
    p_top <- plot_top_weights(
      model,
      view = v,
      factor = f,
      nfeatures = 20
    )
    
    ggsave(
      file.path(outdir, paste0(v, "_F", f, "_topweights.png")),
      p_top, width = 6, height = 4, dpi = 300
    )
    
    
    # =====================================================
    # 3. Scatter (ggplot)
    # =====================================================
    p_scatter <- plot_data_scatter(
      model,
      view = v,
      factor = f,
      features = 12,
      add_lm = TRUE,
      color_by = "cell_line"
    )
    
    ggsave(
      file.path(outdir, paste0(v, "_F", f, "_scatter.png")),
      p_scatter, width = 10, height = 8, dpi = 300
    )
    
    
    # =====================================================
    # 4. Heatmap (pheatmap â†’ device)
    # =====================================================
    png(
      file.path(outdir, paste0(v, "_F", f, "_heatmap.png")),
      width = 1800,
      height = 1200,
      res = 300
    )
    
    plot_data_heatmap(
      model,
      view = v,
      factor = f,
      features = 15,
      cluster_rows = TRUE,
      cluster_cols = TRUE,
      show_rownames = TRUE,
      show_colnames = TRUE,
      fontsize_col = 4# hide crowded labels
    )
    
    dev.off()
  }
}

# Run UMAP
set.seed(42)
model <- run_umap(model)

# Create the UMAP plot
p_umap <- plot_dimred(model,  method = "UMAP",  color_by = "cell_line")

# Save the plot to file
ggsave( filename = file.path(outdir, "UMAP_cellline.png"),
        plot = p_umap,
        width = 6,
        height = 5,
        dpi = 300
)

